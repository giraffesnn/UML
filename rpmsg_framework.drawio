<mxfile host="app.diagrams.net" modified="2020-07-29T06:16:33.029Z" agent="5.0 (Windows)" etag="Awv7BZ7SFVX3dh6U-aSj" version="13.5.3" type="github">
  <diagram id="En-_3escWLUhismutuOt" name="第 1 页">
    <mxGraphModel dx="865" dy="456" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="12000" pageHeight="8000" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-63" value="include/linux/rpmsg.h" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="40" y="40" width="1790" height="320" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-51" value="struct rpmsg_endpoint" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF00FF;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-63" vertex="1">
          <mxGeometry x="1000" y="70" width="240" height="208" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-52" value="struct rpmsg_device *rpdev;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-51" vertex="1">
          <mxGeometry y="26" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-53" value="struct kref refcount;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-51" vertex="1">
          <mxGeometry y="52" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-54" value="rpmsg_rx_cb_t cb;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-51" vertex="1">
          <mxGeometry y="78" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-55" value="struct mutex cb_lock;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-51" vertex="1">
          <mxGeometry y="104" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-56" value="u32 addr;      // local rpmsg address" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-51" vertex="1">
          <mxGeometry y="130" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-57" value="void *priv;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-51" vertex="1">
          <mxGeometry y="156" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-58" value="const struct rpmsg_endpoint_ops *ops;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#EA6B66;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-51" vertex="1">
          <mxGeometry y="182" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-39" value="struct rpmsg_device" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF00FF;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-63" vertex="1">
          <mxGeometry x="520" y="70" width="260" height="208" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-40" value="struct device dev;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-39" vertex="1">
          <mxGeometry y="26" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-41" value="struct rpmsg_device_id id;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#EA6B66;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-39" vertex="1">
          <mxGeometry y="52" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-42" value="u32 src;      // local address" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-39" vertex="1">
          <mxGeometry y="78" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-43" value="u32 dst;      // destination address" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-39" vertex="1">
          <mxGeometry y="104" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-44" value="struct rpmsg_endpoint *ept;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#EA6B66;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-39" vertex="1">
          <mxGeometry y="130" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-45" value="bool announce;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-39" vertex="1">
          <mxGeometry y="156" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-46" value="const struct rpmsg_device_ops *ops;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#EA6B66;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-39" vertex="1">
          <mxGeometry y="182" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-34" value="struct rpmsg_driver" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF00FF;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-63" vertex="1">
          <mxGeometry x="30" y="70" width="330" height="156" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-35" value="struct device_driver drv;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-34" vertex="1">
          <mxGeometry y="26" width="330" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-36" value="const struct rpmsg_device_id *id_table;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#EA6B66;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-34" vertex="1">
          <mxGeometry y="52" width="330" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-37" value="int (*probe)(struct rpmsg_device *dev);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-34" vertex="1">
          <mxGeometry y="78" width="330" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-38" value="void (*remove)(struct rpmsg_device *dev);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-34" vertex="1">
          <mxGeometry y="104" width="330" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-67" value="int (*callback)(struct rpmsg_device *, void *, int, void *, u32);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-34" vertex="1">
          <mxGeometry y="130" width="330" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-71" value="" style="endArrow=block;startArrow=block;endFill=1;startFill=1;html=1;fontFamily=Lucida Console;fontColor=#EA6B66;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="Eo5dm-Wqf6loFh02fLz2-63" source="Eo5dm-Wqf6loFh02fLz2-36" target="Eo5dm-Wqf6loFh02fLz2-41" edge="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="370" y="130" as="sourcePoint" />
            <mxPoint x="530" y="130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-73" value="&lt;div&gt;&lt;div&gt;&lt;font color=&quot;#FF00FF&quot;&gt;&lt;span style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;rpmsg bus:&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#FF00FF&quot;&gt;&lt;span style=&quot;background-color: rgb(255 , 255 , 255)&quot;&gt;rpmsg_dev_match&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#EA6B66;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-63" vertex="1">
          <mxGeometry x="380" y="110" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-109" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#000000;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="Eo5dm-Wqf6loFh02fLz2-63" source="Eo5dm-Wqf6loFh02fLz2-44" target="Eo5dm-Wqf6loFh02fLz2-51" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="880" y="30" as="targetPoint" />
            <Array as="points">
              <mxPoint x="850" y="213" />
              <mxPoint x="850" y="30" />
              <mxPoint x="1120" y="30" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-150" value="&lt;div&gt;rpmsg_driver和&lt;/div&gt;&lt;div&gt;rpmsg_device匹配时，&lt;/div&gt;&lt;div&gt;比较的是.name&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;id_table.name和 &lt;br&gt;&lt;/div&gt;&lt;div&gt;id.name做 strncmp&lt;br&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-63" vertex="1">
          <mxGeometry x="360" y="186" width="140" height="92" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-229" value="if set, rpmsg will announce the creation/removal of this channel" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-63" vertex="1">
          <mxGeometry x="810" y="166" width="180" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-230" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#FF00FF;" parent="Eo5dm-Wqf6loFh02fLz2-63" source="Eo5dm-Wqf6loFh02fLz2-45" target="Eo5dm-Wqf6loFh02fLz2-229" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="910" y="239" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-231" value="&amp;nbsp;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @rpdev: rpmsg channel device&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @refcount: when this drops to zero, the ept is deallocated&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @cb: rx callback handler&lt;br&gt;&amp;nbsp;* @cb_lock: must be taken before accessing/changing @cb&lt;br&gt;&amp;nbsp;* @&lt;font color=&quot;#FF0080&quot;&gt;addr: local rpmsg address&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @priv: private data for the driver&#39;s use&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp; 从本质上来讲，rpmsg endpoint代表了rpmsg bus上的一个listener，因为它&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;将rpmsg address和rx callback handler绑定在一起。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp; 简单的rpmsg driver驱动不应该直接使用这个结构体，因为事情是这样：每一个&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;rpmsg driver在注册到rpmsg bus时，都会提供一个rx callback，当驱动被probe时，该callback会被绑定到它的rpmsg address。当相关的inbound messages到达时（即消息的dst address等于rpmsg channel的src address），驱动程序的处理程序被调用来处理它。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp; 更复杂的rpmsg driver，如果需要分配额外的rpmsg地址，并将它们绑定到不同的rx callback，就必须自己显示地创建额外的endpoint（参见rpmsg_create_ept()）&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-63" vertex="1">
          <mxGeometry x="1290" y="29" width="470" height="290" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-232" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.455;entryDx=0;entryDy=0;entryPerimeter=0;fontFamily=Lucida Console;fontColor=#FF00FF;" parent="Eo5dm-Wqf6loFh02fLz2-63" source="Eo5dm-Wqf6loFh02fLz2-54" target="Eo5dm-Wqf6loFh02fLz2-231" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-103" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#000000;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="Eo5dm-Wqf6loFh02fLz2-46" target="Eo5dm-Wqf6loFh02fLz2-85" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="680" y="460" as="targetPoint" />
            <Array as="points">
              <mxPoint x="680" y="350" />
              <mxPoint x="680" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-76" value="drivers/rpmsg/rpmsg_internal.h" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="440" y="400" width="880" height="320" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-105" value="struct rpmsg_endpoint_ops" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF00FF;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-76" vertex="1">
          <mxGeometry x="600" y="80" width="240" height="234" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-106" value="destroy_ept()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-105" vertex="1">
          <mxGeometry y="26" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-107" value="send()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-105" vertex="1">
          <mxGeometry y="52" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-108" value="sendto()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-105" vertex="1">
          <mxGeometry y="78" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-114" value="send_offchannel()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-105" vertex="1">
          <mxGeometry y="104" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-125" value="trysend()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-105" vertex="1">
          <mxGeometry y="130" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-126" value="trysendto()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-105" vertex="1">
          <mxGeometry y="156" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-127" value="trysend_offchannel()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-105" vertex="1">
          <mxGeometry y="182" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-128" value="poll()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-105" vertex="1">
          <mxGeometry y="208" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-85" value="struct rpmsg_device_ops" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF00FF;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-76" vertex="1">
          <mxGeometry x="120" y="80" width="240" height="104" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-86" value="create_ept()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-85" vertex="1">
          <mxGeometry y="26" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-87" value="announce_create()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-85" vertex="1">
          <mxGeometry y="52" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-88" value="announce_destro()" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-85" vertex="1">
          <mxGeometry y="78" width="240" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-129" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#000000;" parent="1" source="Eo5dm-Wqf6loFh02fLz2-58" target="Eo5dm-Wqf6loFh02fLz2-105" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="960" y="449.9999999999999" as="targetPoint" />
            <Array as="points">
              <mxPoint x="960" y="305" />
              <mxPoint x="960" y="440" />
              <mxPoint x="1160" y="440" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-131" value="samples/renesas_taurus_client/taurus_client_sample.c" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="880" y="1260" width="690" height="740" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-178" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=-0.009;entryDx=0;entryDy=0;entryPerimeter=0;fontFamily=Lucida Console;fontColor=#000000;" parent="Eo5dm-Wqf6loFh02fLz2-131" source="Eo5dm-Wqf6loFh02fLz2-175" target="Eo5dm-Wqf6loFh02fLz2-145" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-175" value="module_rpmsg_driver(taurus_sample_client);" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-131" vertex="1">
          <mxGeometry x="85" y="40" width="320" height="20" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-145" value="struct rpmsg_driver taurus_sample_client" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-131" vertex="1">
          <mxGeometry x="115" y="100" width="260" height="156" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-146" value=".drv.name  = KBUILD_MODNAME," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-145" vertex="1">
          <mxGeometry y="26" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-174" value=".id_table       = taurus_driver_sample_id_table," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-145" vertex="1">
          <mxGeometry y="52" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-147" value=".probe     = taurus_sample_probe," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-145" vertex="1">
          <mxGeometry y="78" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-148" value=".callback  = taurus_sample_cb," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-145" vertex="1">
          <mxGeometry y="104" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-149" value=".remove        = taurus_sample_remove," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-145" vertex="1">
          <mxGeometry y="130" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-179" value="&lt;div align=&quot;left&quot;&gt;static struct rpmsg_device_id taurus_driver_sample_id_table[] = {&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;font color=&quot;#FF0080&quot;&gt;.name = &quot;taurus-virtdev&quot;&lt;/font&gt; },&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { },&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;};&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-131" vertex="1">
          <mxGeometry x="40" y="290" width="360" height="70" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-180" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontFamily=Lucida Console;fontColor=#000000;" parent="Eo5dm-Wqf6loFh02fLz2-131" source="Eo5dm-Wqf6loFh02fLz2-174" target="Eo5dm-Wqf6loFh02fLz2-179" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-11" value="&lt;div&gt;static int taurus_sample_cb(struct rpmsg_device *rpdev, void *data, &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; int len, void *priv, u32 src)&lt;/div&gt;&lt;div&gt;｛&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct taurus_virtdev_res_msg *res = (struct taurus_virtdev_res_msg*)data;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; uint32_t res_id = res-&amp;gt;hdr.Id;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ...&lt;br&gt;&lt;/div&gt;&lt;div&gt;｝&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="Eo5dm-Wqf6loFh02fLz2-131">
          <mxGeometry x="10" y="400" width="570" height="120" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-22" value="&lt;font style=&quot;font-size: 22px&quot; color=&quot;#FF0080&quot;&gt;rpmsg_driver.id_table.name&lt;/font&gt;" style="endArrow=classic;html=1;entryX=-0.004;entryY=0.9;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="Eo5dm-Wqf6loFh02fLz2-131" target="Eo5dm-Wqf6loFh02fLz2-212">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="350" y="340" as="sourcePoint" />
            <mxPoint x="480" y="400" as="targetPoint" />
            <Array as="points">
              <mxPoint x="670" y="630" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-151" value="&lt;div&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b style=&quot;font-size: 16px&quot;&gt;How to write rpmsg drivers?&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b style=&quot;font-size: 16px&quot;&gt;---------------------------&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b style=&quot;font-size: 16px&quot;&gt;&lt;/b&gt;&lt;/font&gt;Documentation/rpmsg.txt&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;samples/rpmsg/rpmsg_client_sample.c&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;samples/renesas_taurus_client/taurus_client_sample.c&lt;br&gt;&lt;/div&gt;&lt;div&gt;drivers/gpu/drm/rcar-rvgc/rcar_rvgc_drv.c&lt;/div&gt;&lt;div&gt;drivers/net/can/rcar-taurus/rcar_taurus_can.c&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255 , 255 , 0)&quot;&gt;TODO:&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;sound/soc/sh/rcar-taurus/*&lt;/div&gt;&lt;div&gt;-------------------------------------&lt;/div&gt;&lt;div&gt;构造一个rpmsg_driver结构体&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;注册: &lt;font color=&quot;#0000FF&quot;&gt;&lt;i&gt;register an rpmsg driver with the rpmsg bus.&lt;/i&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;module_rpmsg_driver(&lt;font color=&quot;#EA6B66&quot;&gt;&lt;i&gt;rpmsg_driver&lt;/i&gt;&lt;/font&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; register_rpmsg_driver(rpmsg_driver)&lt;br&gt;&lt;/div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; __register_rpmsg_driver(rpmsg_driver, THIS_MODULE)&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="200" y="950" width="480" height="430" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-154" value="samples/rpmsg/rpmsg_client_sample.c" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="190" y="1390" width="570" height="730" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-163" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontFamily=Lucida Console;fontColor=#000000;" parent="Eo5dm-Wqf6loFh02fLz2-154" source="Eo5dm-Wqf6loFh02fLz2-160" target="Eo5dm-Wqf6loFh02fLz2-155" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-160" value="module_rpmsg_driver(rpmsg_sample_client);" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-154" vertex="1">
          <mxGeometry x="60" y="50" width="320" height="20" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-155" value="struct rpmsg_driver taurus_sample_client" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-154" vertex="1">
          <mxGeometry x="90" y="100" width="260" height="156" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-156" value=".drv.name  = KBUILD_MODNAME," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-155" vertex="1">
          <mxGeometry y="26" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-165" value=".id_table       = rpmsg_driver_sample_id_table," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-155" vertex="1">
          <mxGeometry y="52" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-157" value=".probe     = taurus_sample_probe," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-155" vertex="1">
          <mxGeometry y="78" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-158" value=".callback  = taurus_sample_cb," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-155" vertex="1">
          <mxGeometry y="104" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-159" value=".remove        = taurus_sample_remove," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-155" vertex="1">
          <mxGeometry y="130" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-164" value="&lt;div align=&quot;left&quot;&gt;static struct rpmsg_device_id rpmsg_driver_sample_id_table[] = {&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;font color=&quot;#FF0080&quot;&gt;.name = &quot;rpmsg-client-sample&quot;&lt;/font&gt; },&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { },&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;};&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-154" vertex="1">
          <mxGeometry x="40" y="280" width="360" height="70" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-166" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontFamily=Lucida Console;fontColor=#000000;" parent="Eo5dm-Wqf6loFh02fLz2-154" source="Eo5dm-Wqf6loFh02fLz2-165" target="Eo5dm-Wqf6loFh02fLz2-164" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="20" y="165" />
              <mxPoint x="20" y="315" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-167" value="&lt;div&gt;int rpmsg_sample_probe(struct rpmsg_device *rpdev) &lt;br&gt;&lt;/div&gt;&lt;div&gt;{&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ...&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /* send a message to our remote processor */&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_send(rpdev-&amp;gt;ept, MSG, strlen(MSG));&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-154" vertex="1">
          <mxGeometry x="60" y="390" width="360" height="110" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-168" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#000000;" parent="Eo5dm-Wqf6loFh02fLz2-154" source="Eo5dm-Wqf6loFh02fLz2-157" target="Eo5dm-Wqf6loFh02fLz2-167" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="490" y="455" as="targetPoint" />
            <Array as="points">
              <mxPoint x="540" y="191" />
              <mxPoint x="540" y="445" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-171" value="#define MSG&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &quot;hello world!&quot;&lt;br&gt;#define MSG_LIMIT&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 100&lt;br&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-154" vertex="1">
          <mxGeometry x="70" y="670" width="280" height="40" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-172" value="&lt;div&gt;int rpmsg_sample_probe(struct rpmsg_device *rpdev) &lt;br&gt;&lt;/div&gt;&lt;div&gt;{&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ...&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /* send a new message now */&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_send(rpdev-&amp;gt;ept, MSG, strlen(MSG));&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ...&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-154" vertex="1">
          <mxGeometry x="60" y="520" width="360" height="110" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-173" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#000000;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="Eo5dm-Wqf6loFh02fLz2-154" source="Eo5dm-Wqf6loFh02fLz2-158" target="Eo5dm-Wqf6loFh02fLz2-172" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="550" as="targetPoint" />
            <Array as="points">
              <mxPoint x="480" y="217" />
              <mxPoint x="480" y="575" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-182" value="drivers/rpmsg/rpmsg_core.c" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1810" y="960" width="1630" height="2980" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-195" value="&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;i&gt;/* register an rpmsg driver with the rpmsg bus */&lt;/i&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;int &lt;font color=&quot;#FF0080&quot;&gt;__register_rpmsg_driver&lt;/font&gt;(struct rpmsg_driver *rpdrv, struct module *owner)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdrv-&amp;gt;drv.bus = &amp;amp;&lt;font color=&quot;#FF0080&quot;&gt;rpmsg_bus&lt;/font&gt;;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdrv-&amp;gt;drv.owner = owner;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return driver_register(&amp;amp;rpdrv-&amp;gt;drv);&lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-182" vertex="1">
          <mxGeometry x="30" y="30" width="600" height="100" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-197" value="int &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_register_device&lt;/font&gt;(struct rpmsg_device *rpdev)&lt;br&gt;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct device *dev = &amp;amp;rpdev-&amp;gt;dev;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; int ret;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dev_set_name(&amp;amp;rpdev-&amp;gt;dev, &quot;%s.%s.%d.%d&quot;, dev_name(dev-&amp;gt;parent),&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdev-&amp;gt;id.name, rpdev-&amp;gt;src, rpdev-&amp;gt;dst);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdev-&amp;gt;dev.bus = &amp;amp;&lt;font color=&quot;#FF0080&quot;&gt;rpmsg_bus&lt;/font&gt;;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ret = device_register(&amp;amp;rpdev-&amp;gt;dev);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (ret) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dev_err(dev, &quot;device_register failed: %d\n&quot;, ret);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; put_device(&amp;amp;rpdev-&amp;gt;dev);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return ret;&lt;br&gt;}" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-182" vertex="1">
          <mxGeometry x="30" y="160" width="520" height="260" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-199" value="struct bus_type rpmsg_bus" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-182" vertex="1">
          <mxGeometry x="130" y="650" width="260" height="182" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-200" value=".name           = &quot;rpmsg&quot;," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-199" vertex="1">
          <mxGeometry y="26" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-201" value=".match          = rpmsg_dev_match," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-199" vertex="1">
          <mxGeometry y="52" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-202" value=".dev_groups     = rpmsg_dev_groups," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-199" vertex="1">
          <mxGeometry y="78" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-211" value=".uevent         = rpmsg_uevent," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-199" vertex="1">
          <mxGeometry y="104" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-203" value=".probe          = rpmsg_dev_probe," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-199" vertex="1">
          <mxGeometry y="130" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-204" value=".remove         = rpmsg_dev_remove," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-199" vertex="1">
          <mxGeometry y="156" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-212" value="&lt;div align=&quot;left&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;/* match rpmsg channel and rpmsg driver */&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;static int &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_dev_match&lt;/font&gt;(struct device *dev, struct device_driver *drv)&lt;br&gt;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_device&lt;/font&gt; *rpdev = to_rpmsg_device(dev);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_driver&lt;/font&gt; *rpdrv = to_rpmsg_driver(drv);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; const struct rpmsg_device_id *ids = rpdrv-&amp;gt;id_table;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; unsigned int i;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (rpdev-&amp;gt;driver_override)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return !strcmp(rpdev-&amp;gt;driver_override, drv-&amp;gt;name);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (ids)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; ids[i].name[0]; i++)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (&lt;font color=&quot;#FF0080&quot;&gt;rpmsg_id_match&lt;/font&gt;(rpdev, &amp;amp;ids[i]))&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return 1;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return of_driver_match_device(dev, drv);&lt;br&gt;}&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;/* rpmsg devices and drivers are matched using the service name */&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;// 比较rpmsg device和rpmsg driver的id.name&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;static inline int rpmsg_id_match(const struct rpmsg_device *rpdev,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; const struct rpmsg_device_id *id)&lt;br&gt;{&lt;br&gt;&amp;nbsp; return strncmp(&lt;font color=&quot;#FF0080&quot;&gt;id-&amp;gt;name&lt;/font&gt;, &lt;font color=&quot;#FF0080&quot;&gt;rpdev-&amp;gt;id.name&lt;/font&gt;, RPMSG_NAME_SIZE) == 0; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;}&lt;/font&gt;&lt;br&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-182" vertex="1">
          <mxGeometry x="60" y="870" width="560" height="380" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-213" value="static int __init rpmsg_init(void)&lt;br&gt;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; int ret;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ret = &lt;font color=&quot;#FF0080&quot;&gt;bus_register(&amp;amp;rpmsg_bus);&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (ret)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; pr_err(&quot;failed to register rpmsg bus: %d\n&quot;, ret);&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return ret;&lt;br&gt;}&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-182" vertex="1">
          <mxGeometry x="30" y="450" width="500" height="160" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-221" value="&lt;font color=&quot;#0000FF&quot;&gt;/*&lt;br&gt;&amp;nbsp;* when an rpmsg driver is probed with a channel, we seamlessly create&lt;br&gt;&amp;nbsp;* it an endpoint, binding its rx callback to a unique local rpmsg&lt;br&gt;&amp;nbsp;* address.&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* if we need to, we also announce about this channel to the remote&lt;br&gt;&amp;nbsp;* processor (needed in case the driver is exposing an rpmsg service).&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*/&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;/* rpmsg driver和rpmsg device匹配后，probe函数中，&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 创建一个&lt;/font&gt;&lt;font color=&quot;#0000FF&quot;&gt;rpmsg_endpoint，并绑定它的rx回调函数到一个唯一的local rpmsg address.&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*/&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;int rpmsg_dev_probe(struct device *dev)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rpmsg_device *rpdev = to_rpmsg_device(dev);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rpmsg_driver *rpdrv = to_rpmsg_driver(rpdev-&amp;gt;dev.driver);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rpmsg_channel_info chinfo = {};&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rpmsg_endpoint *ept = NULL;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; int err;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (rpdrv-&amp;gt;callback) {&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;&lt;i&gt;/* 从rpmsg_device中提取出rpmsg channel信息，保存到rpmsg_channel_info*/&lt;/i&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; strncpy(chinfo.&lt;font color=&quot;#FF0080&quot;&gt;name&lt;/font&gt;, rpdev-&amp;gt;id.name, RPMSG_NAME_SIZE);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; chinfo.&lt;font color=&quot;#FF0080&quot;&gt;src &lt;/font&gt;= rpdev-&amp;gt;src;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; chinfo.&lt;font color=&quot;#FF0080&quot;&gt;dst &lt;/font&gt;= RPMSG_ADDR_ANY;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* 调用rpdev-&amp;gt;ops-&amp;gt;create_ept，创建一个新的rpmsg endpoint */&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ept = &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_create_ept&lt;/font&gt;(rpdev, rpdrv-&amp;gt;callback, NULL, chinfo);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (!ept) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dev_err(dev, &quot;failed to create endpoint\n&quot;);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; err = -ENOMEM;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; goto out;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*&amp;nbsp; */&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdev-&amp;gt;ept = ept;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdev-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;src = ept-&amp;gt;addr&lt;/font&gt;; &lt;font color=&quot;#0000FF&quot;&gt;// src: local address&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* 调用rpmsg driver的.probe函数 */&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; err = rpdrv-&amp;gt;probe(rpdev);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (err) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dev_err(dev, &quot;%s: failed: %d\n&quot;, __func__, err);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (ept)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpmsg_destroy_ept(ept);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; goto out;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* 如果有必要，可以开放这个channel给远程处理器(驱动暴露出rpmsg service的情况下需要) */&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (rpdev-&amp;gt;ops-&amp;gt;announce_create)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; err = rpdev-&amp;gt;ops-&amp;gt;announce_create(rpdev);&lt;br&gt;out:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return err;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-182" vertex="1">
          <mxGeometry x="60" y="1300" width="610" height="820" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-222" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#FF00FF;" parent="Eo5dm-Wqf6loFh02fLz2-182" source="Eo5dm-Wqf6loFh02fLz2-201" target="Eo5dm-Wqf6loFh02fLz2-212" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="690" y="715" />
              <mxPoint x="690" y="1080" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-223" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#FF00FF;entryX=1.016;entryY=0.524;entryDx=0;entryDy=0;entryPerimeter=0;" parent="Eo5dm-Wqf6loFh02fLz2-182" source="Eo5dm-Wqf6loFh02fLz2-203" target="Eo5dm-Wqf6loFh02fLz2-221" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="750" y="1730" as="targetPoint" />
            <Array as="points">
              <mxPoint x="740" y="793" />
              <mxPoint x="740" y="1730" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-224" value="&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;/* rpmsg_create_ept() - create a new rpmsg_endpoint&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 系统中的每一个rpmsg address通过rpmsg_endpoint结构体，绑定到一个rx callback&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* （所以当inbound messages到达时，它们会被rpmsg bus使用适当的回调处理程序派发）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 这个函数允许驱动创建一个endpoint，它绑定一个callback和一些可能的私有数据到一个&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* rpmsg address（可以是事先知道的，也可以是动态分配的）&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 简单的rpmsg driver不需要调用rpmsg_create_ept， 因为在rpmsg bus的probe函数中，已&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 经为它创建了an endpoint（使用rpmsg driver注册到rpmsg bus上时提供的rx callback）&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 因此，对于简单的rpmsg driver来说：它们已经有了一个endpoint,它们的rx callback&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 绑定到它们的rpmsg address，当相关的inbound messages到达时（即它们的dst地址等于&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* rpmsg channel的src地址）,驱动的处理程序被调用来处理它。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 也就是说，更复杂的rpmsg driver可能确实需要分配额外的rpmsg address，并将它们绑定&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 到不同的rx callback。为了达到这个目的，这些驱动程序需要调用这个函数。&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 所以rpmsg driver应该提供它们的@rpdev channel（所以新的endpoint将属于它们的&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* channel所属的同一个remote processor），an rx callback，一个可选的Private data&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* （which is provided back when the rx callback is invoked）,以及一个它们想要&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 绑定到callbakck的address。如果@addr是&lt;font color=&quot;#FF0080&quot;&gt;RPMSG_ADDR_ANY&lt;/font&gt;，那么rpmsg_creat_ept会&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;动态地分配&lt;/font&gt;给它们一个可用的&lt;font color=&quot;#FF0080&quot;&gt;rpmsg address&lt;/font&gt;(驱动程序应该有一个非常好的理由，为什么&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* 不总是在这里使用&lt;/font&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;RPMSG_ADDR_ANY&lt;/font&gt;)&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*/&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;struct rpmsg_endpoint *rpmsg_create_ept(struct rpmsg_device *rpdev,&lt;/div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpmsg_rx_cb_t cb, void *priv,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rpmsg_channel_info chinfo)&lt;br&gt;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (WARN_ON(!rpdev))&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return NULL;&lt;br&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;// OOP: 多态思想的体现，调用各自的rpmsg_device_ops.create_ept&lt;/font&gt;&lt;/div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return &lt;font color=&quot;#FF0080&quot;&gt;rpdev-&amp;gt;ops-&amp;gt;create_ept(rpdev, cb, priv, chinfo);&lt;/font&gt;&lt;br&gt;}" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-182" vertex="1">
          <mxGeometry x="790" y="1600" width="560" height="520" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-225" value="&lt;div&gt;src: local address&lt;/div&gt;&lt;div&gt;dst: destination address&lt;br&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-182" vertex="1">
          <mxGeometry x="580" y="1880" width="190" height="36" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-227" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontFamily=Lucida Console;fontColor=#FF00FF;" parent="Eo5dm-Wqf6loFh02fLz2-182" source="Eo5dm-Wqf6loFh02fLz2-219" target="Eo5dm-Wqf6loFh02fLz2-203" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-219" value="&lt;div&gt;rpmsg_driver和&lt;/div&gt;&lt;div&gt;rpmsg_device的.name匹配成功后，会调用rpmsg_bus.rpmsg_dev_probe&lt;br&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-182" vertex="1">
          <mxGeometry x="-100" y="690" width="190" height="70" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-226" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=1.011;entryY=0.357;entryDx=0;entryDy=0;entryPerimeter=0;fontFamily=Lucida Console;fontColor=#FF00FF;" parent="Eo5dm-Wqf6loFh02fLz2-182" source="Eo5dm-Wqf6loFh02fLz2-201" target="Eo5dm-Wqf6loFh02fLz2-219" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-241" value="" style="endArrow=classic;html=1;fontFamily=Lucida Console;fontColor=#FF00FF;" parent="Eo5dm-Wqf6loFh02fLz2-182" target="Eo5dm-Wqf6loFh02fLz2-224" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="335" y="1700" as="sourcePoint" />
            <mxPoint x="395" y="1750" as="targetPoint" />
            <Array as="points">
              <mxPoint x="450" y="1710" />
              <mxPoint x="580" y="1710" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-56" value="" style="endArrow=classic;html=1;fontColor=#FF0080;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="Eo5dm-Wqf6loFh02fLz2-182" target="rIxsQ2cH_EEwt95zl_0N-8">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1250" y="2100" as="sourcePoint" />
            <mxPoint x="1300" y="2050" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-57" value="&lt;div style=&quot;font-size: 17px&quot; align=&quot;left&quot;&gt;&lt;font style=&quot;font-size: 17px&quot;&gt;1. RPMSG_ADDR_ANY: 动态分配一个可用的rpmsg address;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 17px&quot; align=&quot;left&quot;&gt;&lt;font style=&quot;font-size: 17px&quot;&gt;2. 将rpmsg address绑定到一个rx callback（来自于rpmsg_driver.callback）&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="edgeLabel;html=1;align=left;verticalAlign=middle;resizable=0;points=[];fontColor=#FF0080;rounded=1;" vertex="1" connectable="0" parent="rIxsQ2cH_EEwt95zl_0N-56">
          <mxGeometry x="0.3523" y="1" relative="1" as="geometry">
            <mxPoint x="-124.08999999999999" y="-42.09999999999998" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-196" value="&lt;div style=&quot;font-size: 22px&quot;&gt;&lt;font style=&quot;font-size: 22px&quot; color=&quot;#FF00FF&quot;&gt;在rpmsg_bus上注册rpmsg_driver&lt;/font&gt;&lt;/div&gt;" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#000000;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="Eo5dm-Wqf6loFh02fLz2-175" target="Eo5dm-Wqf6loFh02fLz2-195" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1560" y="980.0000000000002" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-217" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Lucida Console;fontColor=#FF00FF;" parent="1" source="Eo5dm-Wqf6loFh02fLz2-150" target="Eo5dm-Wqf6loFh02fLz2-212" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1730" y="2037.0588235294117" as="targetPoint" />
            <Array as="points">
              <mxPoint x="470" y="380" />
              <mxPoint x="370" y="380" />
              <mxPoint x="370" y="840" />
              <mxPoint x="1690" y="840" />
              <mxPoint x="1690" y="1990" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-243" value="drivers/rpmsg/virtio_rpmsg_bus.c" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="3580" y="980" width="1990" height="2330" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-245" value="&lt;div&gt;static int __init rpmsg_init(void)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; register_virtio_driver(&amp;amp;&lt;font color=&quot;#FF0080&quot;&gt;virtio_ipc_driver&lt;/font&gt;);&lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-243" vertex="1">
          <mxGeometry x="67.5" y="40" width="355" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-254" value="struct virtio_driver virtio_ipc_driver" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-243" vertex="1">
          <mxGeometry x="90" y="130" width="260" height="208" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-255" value=".feature_table  = features," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-254" vertex="1">
          <mxGeometry y="26" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-256" value=".feature_table_size = ARRAY_SIZE(features)," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-254" vertex="1">
          <mxGeometry y="52" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-257" value=".driver.name    = KBUILD_MODNAME," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-254" vertex="1">
          <mxGeometry y="78" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-258" value=".driver.owner   = THIS_MODULE," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-254" vertex="1">
          <mxGeometry y="104" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-259" value=".id_table       = id_table," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-254" vertex="1">
          <mxGeometry y="130" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-260" value=".probe          = rpmsg_probe," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-254" vertex="1">
          <mxGeometry y="156" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-270" value=".remove         = rpmsg_remove," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-254" vertex="1">
          <mxGeometry y="182" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-272" value="" style="endArrow=classic;html=1;fontFamily=Lucida Console;fontColor=#FF0080;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="Eo5dm-Wqf6loFh02fLz2-243" target="Eo5dm-Wqf6loFh02fLz2-254" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="330" y="90" as="sourcePoint" />
            <mxPoint x="290" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-274" value="&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;static unsigned int features[] = {&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;VIRTIO_RPMSG_F_NS&lt;/font&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;};&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;shadow=0;labelBackgroundColor=#FFF4C3;fontFamily=Lucida Console;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-243" vertex="1">
          <mxGeometry x="400" y="147" width="250" height="44" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-276" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontFamily=Lucida Console;fontColor=#FF0080;" parent="Eo5dm-Wqf6loFh02fLz2-243" source="Eo5dm-Wqf6loFh02fLz2-255" target="Eo5dm-Wqf6loFh02fLz2-274" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-277" value="&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;struct virtio_device_id id_table[] = {&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp; { &lt;font color=&quot;#FF0080&quot;&gt;VIRTIO_ID_RPMSG&lt;/font&gt;, &lt;font color=&quot;#FF0080&quot;&gt;VIRTIO_DEV_ANY_ID &lt;/font&gt;},&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp; { 0 },&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;};&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;shadow=0;labelBackgroundColor=#FFF4C3;fontFamily=Lucida Console;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-243" vertex="1">
          <mxGeometry x="400" y="243" width="310" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-278" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontFamily=Lucida Console;fontColor=#FF0080;" parent="Eo5dm-Wqf6loFh02fLz2-243" source="Eo5dm-Wqf6loFh02fLz2-259" target="Eo5dm-Wqf6loFh02fLz2-277" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Eo5dm-Wqf6loFh02fLz2-279" value="&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;int rpmsg_probe(struct virtio_device *vdev)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;{&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vq_callback_t *&lt;font color=&quot;#FF0080&quot;&gt;vq_cbs&lt;/font&gt;[] = { &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_recv_done&lt;/font&gt;, &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_xmit_done &lt;/font&gt;};&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; static const char * const &lt;font color=&quot;#FF0080&quot;&gt;names&lt;/font&gt;[] = { &quot;&lt;font color=&quot;#FF0080&quot;&gt;input&lt;/font&gt;&quot;, &quot;&lt;font color=&quot;#FF0080&quot;&gt;output&lt;/font&gt;&quot; };&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct virtqueue *vqs[2];&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct virtproc_info *vrp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vrp = kzalloc(sizeof(*vrp), GFP_KERNEL);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* We expect two virtqueues, rx and tx (and in this order) */&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;virtio_find_vqs&lt;/font&gt;(vdev, 2, vqs, &lt;font color=&quot;#FF0080&quot;&gt;vq_cbs&lt;/font&gt;, &lt;font color=&quot;#FF0080&quot;&gt;names&lt;/font&gt;, NULL);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vrp-&amp;gt;rvq = vqs[0];&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vrp-&amp;gt;svq = vqs[1];&lt;br&gt;&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* we need less buffers if vrings are small */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (virtqueue_get_vring_size(vrp-&amp;gt;rvq) &amp;lt; MAX_RPMSG_NUM_BUFS / 2)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vrp-&amp;gt;num_bufs = &lt;font color=&quot;#0000FF&quot;&gt;virtqueue_get_vring_size&lt;/font&gt;(vrp-&amp;gt;rvq) * 2;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; else&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vrp-&amp;gt;num_bufs = MAX_RPMSG_NUM_BUFS;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vrp-&amp;gt;buf_size = MAX_RPMSG_BUF_SIZE;&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; total_buf_space = vrp-&amp;gt;num_bufs * vrp-&amp;gt;buf_size;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* allocate coherent memory for the buffers */&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;// 为virtqueue申请内存&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; bufs_va = &lt;font color=&quot;#FF0080&quot;&gt;dma_alloc_coherent&lt;/font&gt;(vdev-&amp;gt;dev.parent-&amp;gt;parent,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; total_buf_space, &amp;amp;vrp-&amp;gt;bufs_dma,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; GFP_KERNEL);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* half of the buffers is dedicated for RX */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vrp-&amp;gt;rbufs = bufs_va;&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* and half is dedicated for TX */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vrp-&amp;gt;sbufs = bufs_va + total_buf_space / 2;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* set up the receive buffers */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; i &amp;lt; vrp-&amp;gt;num_bufs / 2; i++) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct scatterlist sg;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; void *cpu_addr = vrp-&amp;gt;rbufs + i * vrp-&amp;gt;buf_size;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /* initialize scatterlist according to cpu address location&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * An internal function filling scatterlist according to&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * virtual address location (in vmalloc or in kernel).&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; */&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_sg_init&lt;/font&gt;(vrp, &amp;amp;sg, cpu_addr, vrp-&amp;gt;buf_size);&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; err = &lt;font color=&quot;#FF0080&quot;&gt;dma_virtqueue_add_inbuf&lt;/font&gt;(vrp-&amp;gt;rvq, &amp;amp;sg, 1, cpu_addr,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; GFP_KERNEL);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; WARN_ON(err); /* sanity check; this can&#39;t really happen */&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* suppress &quot;tx-complete&quot; interrupts */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;virtqueue_disable_cb&lt;/font&gt;(vrp-&amp;gt;svq);&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vdev-&amp;gt;priv = vrp;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* if supported by the remote processor, enable the name service */&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (virtio_has_feature(vdev, VIRTIO_RPMSG_F_NS)) {&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* a dedicated endpoint handles the name service msgs */&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* 这里创建了一个专门的endpoint，来处理name seivice messages. */&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vrp-&amp;gt;ns_ept = &lt;font color=&quot;#FF0080&quot;&gt;__rpmsg_create_ept&lt;/font&gt;(vrp, NULL, &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_ns_cb&lt;/font&gt;,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vrp, RPMSG_NS_ADDR);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ...&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * Prepare to kick but don&#39;t notify yet - we can&#39;t do this before&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * device is ready.&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; notify = &lt;font color=&quot;#FF0080&quot;&gt;virtqueue_kick_prepare&lt;/font&gt;(vrp-&amp;gt;rvq);&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* From this point on, we can notify and get callbacks. */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;virtio_device_ready&lt;/font&gt;(vdev);&lt;br&gt;&lt;br&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /* tell the remote processor it can start sending messages */&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * this might be concurrent with callbacks, but we are only&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * doing notify, not a full kick here, so that&#39;s ok.&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (notify)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;virtqueue_notify&lt;/font&gt;(vrp-&amp;gt;rvq);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;}&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;shadow=0;labelBackgroundColor=#FFF4C3;fontFamily=Lucida Console;fontColor=#FF0080;rounded=1;" parent="Eo5dm-Wqf6loFh02fLz2-243" vertex="1">
          <mxGeometry x="30" y="350" width="563.24" height="1280" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-1" value="&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;/* invoked when a name service announcement arrives */&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;static int rpmsg_ns_cb(struct rpmsg_device *rpdev, void *data, int len,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; void *priv, u32 src)&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;{&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_ns_msg *msg&lt;/font&gt; = data;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rpmsg_device *newch;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_channel_info chinfo&lt;/font&gt;;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct virtproc_info *vrp = priv;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct device *dev = &amp;amp;vrp-&amp;gt;vdev-&amp;gt;dev;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * &lt;font color=&quot;#FF0080&quot;&gt;the name service ept does _not_ belong to a real rpmsg channel,&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * &lt;font color=&quot;#FF0080&quot;&gt;and is handled by the rpmsg bus itself.&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * for sanity reasons, make sure a valid rpdev has _not_ sneaked&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * in somehow.&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (rpdev) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dev_err(dev, &quot;anomaly: ns ept has an rpdev handle\n&quot;);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return -EINVAL;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;// 将remote service的name拷贝给rpmsg_channel_info&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; strncpy(&lt;font color=&quot;#FF0080&quot;&gt;chinfo.name, msg-&amp;gt;name&lt;/font&gt;, sizeof(chinfo.name));&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; chinfo.src = &lt;font color=&quot;#FF0080&quot;&gt;RPMSG_ADDR_ANY&lt;/font&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; chinfo.dst = &lt;font color=&quot;#FF0080&quot;&gt;msg-&amp;gt;addr&lt;/font&gt;;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ...&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; newch = &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_create_channel&lt;/font&gt;(vrp, &amp;amp;&lt;font color=&quot;#FF0080&quot;&gt;chinfo&lt;/font&gt;);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;} &amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/font&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;shadow=0;labelBackgroundColor=#FFF4C3;fontFamily=Lucida Console;fontColor=#FF0080;rounded=1;" vertex="1" parent="Eo5dm-Wqf6loFh02fLz2-243">
          <mxGeometry x="660" y="370" width="540" height="420" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-6" value="&lt;font color=&quot;#0000FF&quot;&gt;/*&lt;br&gt;&amp;nbsp;* create an rpmsg channel using its name and address info.&lt;br&gt;&amp;nbsp;* this function will be used to create both static and dynamic&lt;br&gt;&amp;nbsp;* channels.&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*/&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;static struct rpmsg_device *rpmsg_create_channel(struct virtproc_info *vrp, &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rpmsg_channel_info *chinfo)&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#000000&quot;&gt;｛&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp; struct virtio_rpmsg_channel *vch;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rpmsg_device *rpdev;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct device *tmp, *dev = &amp;amp;vrp-&amp;gt;vdev-&amp;gt;dev;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* make sure a similar channel doesn&#39;t already exist */&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_find_device&lt;/font&gt;(dev, chinfo);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vch = kzalloc(sizeof(*vch), GFP_KERNEL);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;font color=&quot;#0000FF&quot;&gt; /* Link the channel to our vrp */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; vch-&amp;gt;vrp = vrp;&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* Assign public information to the rpmsg_device */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdev = &amp;amp;vch-&amp;gt;rpdev;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;rpdev-&amp;gt;src = chinfo-&amp;gt;src&lt;/font&gt;;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;rpdev-&amp;gt;dst = chinfo-&amp;gt;dst&lt;/font&gt;;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdev-&amp;gt;ops = &amp;amp;&lt;font color=&quot;#FF0080&quot;&gt;virtio_rpmsg_ops&lt;/font&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; /*&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * rpmsg server channels has predefined local address (for now),&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; * and their existence needs to be announced remotely&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdev-&amp;gt;announce = rpdev-&amp;gt;src != RPMSG_ADDR_ANY;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;// 将&lt;/font&gt;&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;rpmsg_channel_info的service name传给rpmsg device的id.name&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; strncpy(&lt;font color=&quot;#FF0080&quot;&gt;rpdev-&amp;gt;id.name, chinfo-&amp;gt;name&lt;/font&gt;, RPMSG_NAME_SIZE);&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdev-&amp;gt;dev.parent = &amp;amp;vrp-&amp;gt;vdev-&amp;gt;dev;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpdev-&amp;gt;dev.release = virtio_rpmsg_release_device;&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;/font&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#000000&quot;&gt;&lt;font color=&quot;#FF0080&quot;&gt;rpmsg_register_device&lt;/font&gt;(rpdev);&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;｝&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;shadow=0;labelBackgroundColor=#FFF4C3;fontFamily=Lucida Console;fontColor=#FF0080;rounded=1;" vertex="1" parent="Eo5dm-Wqf6loFh02fLz2-243">
          <mxGeometry x="660" y="870" width="550" height="550" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-7" value="&lt;div&gt;src: local address&lt;/div&gt;&lt;div&gt;dst: destination address&lt;br&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="Eo5dm-Wqf6loFh02fLz2-243">
          <mxGeometry x="970" y="1180" width="190" height="36" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-8" value="&lt;font color=&quot;#000000&quot;&gt;static const struct &lt;font color=&quot;#FF0080&quot;&gt;rpmsg_device_ops&lt;/font&gt; virtio_rpmsg_ops = {&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; .create_ept = &lt;font color=&quot;#FF0080&quot;&gt;virtio_rpmsg_create_ept&lt;/font&gt;,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; .announce_create = virtio_rpmsg_announce_create,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; .announce_destroy = virtio_rpmsg_announce_destroy,&lt;br&gt;};&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;shadow=0;labelBackgroundColor=#FFF4C3;fontFamily=Lucida Console;fontColor=#FF0080;rounded=1;" vertex="1" parent="Eo5dm-Wqf6loFh02fLz2-243">
          <mxGeometry x="48.239999999999995" y="1670" width="545" height="90" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-10" value="" style="endArrow=classic;html=1;entryX=0.441;entryY=-0.007;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="Eo5dm-Wqf6loFh02fLz2-243" source="rIxsQ2cH_EEwt95zl_0N-1" target="rIxsQ2cH_EEwt95zl_0N-6">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="820" y="770" as="sourcePoint" />
            <mxPoint x="930" y="850" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-19" value="" style="endArrow=classic;html=1;entryX=1.004;entryY=0.446;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="Eo5dm-Wqf6loFh02fLz2-243" target="Eo5dm-Wqf6loFh02fLz2-197">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="720" y="1400" as="sourcePoint" />
            <mxPoint x="530" y="1370" as="targetPoint" />
            <Array as="points">
              <mxPoint x="640" y="1630" />
              <mxPoint x="580" y="1630" />
              <mxPoint x="410" y="1630" />
              <mxPoint x="220" y="1630" />
              <mxPoint x="70" y="1610" />
              <mxPoint y="1590" />
              <mxPoint x="-70" y="1510" />
              <mxPoint x="-70" y="1400" />
              <mxPoint x="-70" y="1310" />
              <mxPoint x="-70" y="266" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-20" value="&lt;font style=&quot;font-size: 22px&quot; color=&quot;#FF0080&quot;&gt;在rpmsg bus上注册rpmsg device&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];rounded=1;" vertex="1" connectable="0" parent="rIxsQ2cH_EEwt95zl_0N-19">
          <mxGeometry x="0.5684" y="1" relative="1" as="geometry">
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-23" value="" style="endArrow=classic;html=1;entryX=1;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="Eo5dm-Wqf6loFh02fLz2-243" target="Eo5dm-Wqf6loFh02fLz2-212">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="710" y="1340" as="sourcePoint" />
            <mxPoint x="340" y="1380" as="targetPoint" />
            <Array as="points">
              <mxPoint x="580" y="1620" />
              <mxPoint x="-40" y="1590" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-24" value="&lt;font style=&quot;font-size: 22px&quot; color=&quot;#FF0080&quot;&gt;rpmsg_device.id.name&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];rounded=1;" vertex="1" connectable="0" parent="rIxsQ2cH_EEwt95zl_0N-23">
          <mxGeometry x="0.0934" y="1" relative="1" as="geometry">
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-28" value="&lt;font color=&quot;#0000FF&quot;&gt;/**&lt;br&gt;&amp;nbsp;* struct rpmsg_ns_msg - dynamic name service announcement message&lt;br&gt;&amp;nbsp;* @name: &lt;font color=&quot;#FF0080&quot;&gt;name of remote service that is published&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @addr: &lt;font color=&quot;#FF0080&quot;&gt;address of remote service that is published&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @flags: indicates whether service is created or destroyed&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* This message is sent across to publish a new service, or announce&lt;br&gt;&amp;nbsp;* about its removal. When we receive these messages, an appropriate&lt;br&gt;&amp;nbsp;* rpmsg channel (i.e device) is created/destroyed. In turn, the -&amp;gt;probe()&lt;br&gt;&amp;nbsp;* or -&amp;gt;remove() handler of the appropriate rpmsg driver will be invoked&lt;br&gt;&amp;nbsp;* (if/as-soon-as one is registered).&lt;br&gt;&amp;nbsp;*/&lt;/font&gt;&lt;br&gt;struct rpmsg_ns_msg {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; char name[RPMSG_NAME_SIZE];&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; u32 addr;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; u32 flags;&lt;br&gt;} __packed;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="Eo5dm-Wqf6loFh02fLz2-243">
          <mxGeometry x="1230" y="370" width="585" height="260" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-29" value="" style="endArrow=classic;html=1;entryX=0;entryY=0.095;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="Eo5dm-Wqf6loFh02fLz2-243" target="rIxsQ2cH_EEwt95zl_0N-28">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="840" y="430" as="sourcePoint" />
            <mxPoint x="1270" y="420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-32" value="" style="endArrow=classic;html=1;" edge="1" parent="Eo5dm-Wqf6loFh02fLz2-243" target="rIxsQ2cH_EEwt95zl_0N-27">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="720" y="1330" as="sourcePoint" />
            <mxPoint x="650" y="1270" as="targetPoint" />
            <Array as="points">
              <mxPoint x="650" y="1370" />
              <mxPoint x="610" y="1648" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-51" value="&lt;font color=&quot;#0000FF&quot;&gt;/* for more info, see below documentation of rpmsg_create_ept() */&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#000000&quot;&gt;static struct rpmsg_endpoint *&lt;font color=&quot;#FF0080&quot;&gt;__rpmsg_create_ept&lt;/font&gt;(struct virtproc_info *vrp,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rpmsg_device *rpdev,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rpmsg_rx_cb_t cb,&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; void *priv, u32 addr)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;{&lt;/font&gt;&lt;/div&gt;&lt;blockquote&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp; struct rpmsg_endpoint *ept;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp; ept = kzalloc(sizeof(*ept), GFP_KERNEL);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp; ept-&amp;gt;rpdev = rpdev;&lt;br&gt;&amp;nbsp; ept-&amp;gt;cb = &lt;font color=&quot;#FF0080&quot;&gt;cb&lt;/font&gt;;&lt;br&gt;&amp;nbsp; ept-&amp;gt;priv = priv;&lt;br&gt;&amp;nbsp; ept-&amp;gt;ops = &amp;amp;&lt;font color=&quot;#FF0080&quot;&gt;virtio_endpoint_ops&lt;/font&gt;;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* do we need to allocate a local address ? */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (addr == &lt;font color=&quot;#FF0080&quot;&gt;RPMSG_ADDR_ANY&lt;/font&gt;) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; id_min = &lt;font color=&quot;#0000FF&quot;&gt;RPMSG_RESERVED_ADDRESSES&lt;/font&gt;;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; id_max = 0;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } else {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; id_min = addr;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; id_max = addr + 1;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* bind the endpoint to an rpmsg address (and allocate one if needed) */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; id = idr_alloc(&amp;amp;vrp-&amp;gt;endpoints, ept, id_min, id_max, GFP_KERNEL);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (id &amp;lt; 0) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dev_err(dev, &quot;idr_alloc failed: %d\n&quot;, id);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; goto free_ept;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ept-&amp;gt;addr = id;&lt;br&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;}&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;shadow=0;labelBackgroundColor=#FFF4C3;fontFamily=Lucida Console;fontColor=#FF0080;rounded=1;" vertex="1" parent="Eo5dm-Wqf6loFh02fLz2-243">
          <mxGeometry x="70" y="1820" width="590" height="500" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-245" value="" style="endArrow=classic;html=1;fontSize=14;fontColor=#FF0080;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="Eo5dm-Wqf6loFh02fLz2-243" target="rIxsQ2cH_EEwt95zl_0N-51">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="110" y="1710" as="sourcePoint" />
            <mxPoint x="20" y="1750" as="targetPoint" />
            <Array as="points">
              <mxPoint x="90" y="1760" />
              <mxPoint x="350" y="1780" />
              <mxPoint x="330" y="1810" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-33" value="cr7-vlib/app/taurus/comal/src/rpmsg/r_rte_comal_rpmsg_main.c" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="3820" y="4700" width="1200" height="1170" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-34" value="R_RTE_COMAL_Rpmsg_Service_t" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF00FF;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-33">
          <mxGeometry x="20" y="50" width="440" height="130" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-35" value="char                        name[RTE_COMAL_SERVICE_NAME_LEN];" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-34">
          <mxGeometry y="26" width="440" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-36" value="unsigned int                service_port;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-34">
          <mxGeometry y="52" width="440" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-37" value="unsigned int                guest_port;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-34">
          <mxGeometry y="78" width="440" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-38" value="R_TAURUS_Peripheral_Id_t    peripheral_id;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-34">
          <mxGeometry y="104" width="440" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-47" value="&lt;font color=&quot;#000000&quot;&gt;/* List of services announced to the guest by the TAURUS server. */&lt;br&gt;static &lt;font color=&quot;#FF0080&quot;&gt;R_RTE_COMAL_Rpmsg_Service_t&lt;/font&gt; guest1_services[] = {&lt;br&gt;#if defined(R_TAURUS_ENABLE_VIRTDEV)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.name = &quot;&lt;font color=&quot;#FF0080&quot;&gt;taurus-virtdev&lt;/font&gt;&quot;,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.service_port = &lt;font color=&quot;#FF0080&quot;&gt;TAURUS_PROTOCOL_VIRTDEV_ID&lt;/font&gt;,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.guest_port = 0,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.peripheral_id = &lt;font color=&quot;#FF0080&quot;&gt;R_TAURUS_VIRTDEV_PERI_ID&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; },&lt;br&gt;#endif&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#000000&quot;&gt;#if defined(R_TAURUS_ENABLE_RVGC)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.name = &quot;&lt;font color=&quot;#FF0080&quot;&gt;taurus-rvgc&lt;/font&gt;&quot;,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.service_port = &lt;font color=&quot;#FF0080&quot;&gt;TAURUS_PROTOCOL_RVGC_ID&lt;/font&gt;,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.guest_port = 0,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.peripheral_id = &lt;font color=&quot;#FF0080&quot;&gt;R_TAURUS_RVGC_PERI_ID&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; },&lt;br&gt;#endif&lt;br&gt;#if defined(R_TAURUS_ENABLE_CAN)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.name = &quot;&lt;font color=&quot;#FF0080&quot;&gt;taurus-can&lt;/font&gt;&quot;,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.service_port = &lt;font color=&quot;#FF0080&quot;&gt;TAURUS_PROTOCOL_CAN_ID&lt;/font&gt;,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.guest_port = 0,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.peripheral_id = R_TAURUS_CAN_PERI_ID&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; },&lt;br&gt;#endif&lt;br&gt;#if defined(R_TAURUS_ENABLE_IPMMUWA)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.name = &quot;&lt;font color=&quot;#FF0080&quot;&gt;taurus-ipmmuwa&lt;/font&gt;&quot;,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.service_port = &lt;font color=&quot;#FF0080&quot;&gt;TAURUS_PROTOCOL_IPMMUWA_ID&lt;/font&gt;,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.guest_port = 0,&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;.peripheral_id = &lt;font color=&quot;#FF0080&quot;&gt;R_TAURUS_IPMMUWA_PERI_ID&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; },&lt;br&gt;#endif&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; RPMSG_SERVICE_SENTINEL&lt;br&gt;};&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;shadow=0;labelBackgroundColor=#FFF4C3;fontFamily=Lucida Console;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-33">
          <mxGeometry x="10" y="220" width="490" height="530" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-48" value="&lt;div&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b style=&quot;font-size: 16px&quot;&gt;remote processor如何编写驱动？&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b style=&quot;font-size: 16px&quot;&gt;---------------------------&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="3010" y="4980" width="480" height="430" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-71" value="drivers/virtio/virtio.c" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="5760" y="980" width="1250" height="1680" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-72" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontFamily=Lucida Console;fontColor=#000000;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-71" source="rIxsQ2cH_EEwt95zl_0N-73" target="rIxsQ2cH_EEwt95zl_0N-74">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-73" value="bus_register(&amp;amp;virtio_bus)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-71">
          <mxGeometry x="120" y="50" width="200" height="20" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-74" value="struct bus_type virtio_bus" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-71">
          <mxGeometry x="90" y="100" width="260" height="182" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-75" value=".name  = &quot;virtio&quot;," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-74">
          <mxGeometry y="26" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-76" value=".match = virtio_dev_match," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-74">
          <mxGeometry y="52" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-77" value=".dev_groups = virtio_dev_groups," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-74">
          <mxGeometry y="78" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-78" value=".uevent = virtio_uevent," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-74">
          <mxGeometry y="104" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-79" value=".probe = virtio_dev_probe," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-74">
          <mxGeometry y="130" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-87" value=".remove = virtio_dev_remove," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-74">
          <mxGeometry y="156" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-80" value="&lt;div&gt;int virtio_dev_match(struct device *_dv, struct device_driver *_dr)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct virtio_device *dev = dev_to_virtio(_dv);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; const struct &lt;font color=&quot;#FF0080&quot;&gt;virtio_device_id *ids&lt;/font&gt;;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ids = drv_to_virtio(_dr)-&amp;gt;id_table;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; ids[i].device; i++)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (&lt;font color=&quot;#FF0080&quot;&gt;virtio_id_match&lt;/font&gt;(dev, &amp;amp;ids[i]))&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return 1;&lt;br&gt;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-71">
          <mxGeometry x="50" y="300" width="490" height="160" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-88" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.002;entryY=0.546;entryDx=0;entryDy=0;entryPerimeter=0;fontColor=#FF0080;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-71" source="rIxsQ2cH_EEwt95zl_0N-76" target="rIxsQ2cH_EEwt95zl_0N-80">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="30" y="165" />
              <mxPoint x="30" y="387" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-89" value="&lt;div&gt;static inline int virtio_id_match(const struct virtio_device *dev,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; const struct virtio_device_id *id) &lt;br&gt;&lt;/div&gt;&lt;div&gt;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (id-&amp;gt;device != dev-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;id.device&lt;/font&gt; &amp;amp;&amp;amp; &lt;font color=&quot;#FF0080&quot;&gt;id-&amp;gt;device !=VIRTIO_DEV_ANY_ID&lt;/font&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return &lt;font color=&quot;#FF0080&quot;&gt;id-&amp;gt;vendor == VIRTIO_DEV_ANY_ID || id-&amp;gt;vendor == dev-&amp;gt;id.vendor;&lt;/font&gt;&lt;br&gt;}&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-71">
          <mxGeometry x="50" y="480" width="590" height="140" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-93" value="&lt;div&gt;int virtio_dev_probe(struct device *_d)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct virtio_device *dev = dev_to_virtio(_d);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct virtio_driver *drv = drv_to_virtio(dev-&amp;gt;dev.driver);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; u64 device_features;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; u64 driver_features;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; u64 driver_features_legacy;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* We have a driver! */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; virtio_add_status(dev, &lt;font color=&quot;#FF0080&quot;&gt;VIRTIO_CONFIG_S_DRIVER&lt;/font&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* Figure out what features the device supports. */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; device_features = dev-&amp;gt;config-&amp;gt;get_features(dev);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* Figure out what features the driver supports. */&lt;/font&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; driver_features = 0;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; i &amp;lt; drv-&amp;gt;feature_table_size; i++) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; unsigned int f = drv-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;feature_table&lt;/font&gt;[i];&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; BUG_ON(f &amp;gt;= 64);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; driver_features |= (1ULL &amp;lt;&amp;lt; f);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* Some drivers have a separate feature table for virtio v1.0 */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (drv-&amp;gt;feature_table_legacy) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; driver_features_legacy = 0;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = 0; i &amp;lt; drv-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;feature_table_size_legacy&lt;/font&gt;; i++) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; unsigned int f = drv-&amp;gt;feature_table_legacy[i];&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; BUG_ON(f &amp;gt;= 64);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; driver_features_legacy |= (1ULL &amp;lt;&amp;lt; f);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } else {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; driver_features_legacy = driver_features;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (device_features &amp;amp; (1ULL &amp;lt;&amp;lt; VIRTIO_F_VERSION_1))&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;dev-&amp;gt;features = driver_features &amp;amp; device_features&lt;/font&gt;;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; else&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;dev-&amp;gt;features = driver_features_legacy &amp;amp; device_features&lt;/font&gt;;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* Transport features always preserved to pass to finalize_features. */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; for (i = &lt;font color=&quot;#FF0080&quot;&gt;VIRTIO_TRANSPORT_F_START&lt;/font&gt;; i &amp;lt; &lt;font color=&quot;#FF0080&quot;&gt;VIRTIO_TRANSPORT_F_END&lt;/font&gt;; i++)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (device_features &amp;amp; (1ULL &amp;lt;&amp;lt; i))&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;__virtio_set_bit&lt;/font&gt;(dev, i);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; virtio_finalize_features(dev); &lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; drv-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;probe&lt;/font&gt;(dev);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* If probe didn&#39;t do it, mark device DRIVER_OK ourselves. */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (!(dev-&amp;gt;config-&amp;gt;get_status(dev) &amp;amp; VIRTIO_CONFIG_S_DRIVER_OK))&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; virtio_device_ready(dev);&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (drv-&amp;gt;scan)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; drv-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;scan&lt;/font&gt;(dev);&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;virtio_config_enable&lt;/font&gt;(dev);&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-71">
          <mxGeometry x="45" y="670" width="585" height="850" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-94" value="&lt;div&gt;void virtio_add_status(struct virtio_device *dev, unsigned int status)&lt;br&gt;&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dev-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;config-&amp;gt;set_status&lt;/font&gt;(dev, dev-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;config-&amp;gt;get_status&lt;/font&gt;(dev) | status);&lt;br&gt;}" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-71">
          <mxGeometry x="630" y="700" width="560" height="60" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-237" value="&lt;font color=&quot;#0000FF&quot;&gt;/* &lt;font color=&quot;#FF0080&quot;&gt;Some virtio feature bits (currently bits 28 through 32)&lt;/font&gt; are &lt;font color=&quot;#FF0080&quot;&gt;reserved&lt;/font&gt; for the&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;transport being used (eg. virtio_ring)&lt;/font&gt;, the rest are per-device feature&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* bits. &lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*/&lt;/font&gt;&lt;/div&gt;&lt;div&gt;#define &lt;font color=&quot;#FF0080&quot;&gt;VIRTIO_TRANSPORT_F_START&lt;/font&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 28&lt;/div&gt;&lt;div&gt;#define VIRTIO_TRANSPORT_F_END&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 34&lt;br&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-71">
          <mxGeometry x="650" y="1220" width="585" height="90" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-238" value="" style="endArrow=classic;html=1;fontSize=14;fontColor=#FF0080;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-71" target="rIxsQ2cH_EEwt95zl_0N-94">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="230" y="800" as="sourcePoint" />
            <mxPoint x="280" y="750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-240" value="" style="endArrow=classic;html=1;fontSize=14;fontColor=#FF0080;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-71" target="rIxsQ2cH_EEwt95zl_0N-237">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="470" y="1260" as="sourcePoint" />
            <mxPoint x="560" y="1290" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-241" value="" style="endArrow=classic;html=1;fontSize=14;fontColor=#FF0080;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-71" target="Eo5dm-Wqf6loFh02fLz2-260">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="100" y="1340" as="sourcePoint" />
            <mxPoint x="20" y="1270" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-80" y="1340" />
              <mxPoint x="-20" y="810" />
              <mxPoint x="-270" y="390" />
              <mxPoint x="-320" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-91" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontColor=#FF0080;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="Eo5dm-Wqf6loFh02fLz2-277" target="rIxsQ2cH_EEwt95zl_0N-89">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="5695.882352941176" y="1570" as="targetPoint" />
            <Array as="points">
              <mxPoint x="5650" y="1253" />
              <mxPoint x="5650" y="1530" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-92" value="&lt;div style=&quot;font-size: 14px;&quot;&gt;virtio_driver 和&amp;nbsp; virtio_device的匹配条件:&lt;/div&gt;&lt;div style=&quot;font-size: 14px;&quot; align=&quot;left&quot;&gt;1. virtio_driver.id_table-&amp;gt;device = &lt;font style=&quot;font-size: 14px;&quot; color=&quot;#000000&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#FF0080&quot;&gt;&lt;i style=&quot;font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#000000&quot;&gt;VIRTIO_DEV_ANY_ID&lt;/font&gt;&lt;/i&gt;(即该驱动适用于所有的virtio_device);&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 14px;&quot; align=&quot;left&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#000000&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#FF0080&quot;&gt;2. &lt;/font&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#000000&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#FF0080&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#000000&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#FF0080&quot;&gt;virtio_device.id-&amp;gt;vendor == &lt;/font&gt;&lt;/font&gt;&lt;/font&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#000000&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#FF0080&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#000000&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#FF0080&quot;&gt;virtio_driver.id_table-&amp;gt;verndor(在驱动列表中，找到id_table-&amp;gt;vendor相等的驱动)&lt;/font&gt;&lt;/font&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#FF0080;fontSize=14;rounded=1;" vertex="1" connectable="0" parent="rIxsQ2cH_EEwt95zl_0N-91">
          <mxGeometry x="-0.0754" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-110" value="include/linux/virtio.h" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="3990" y="140" width="1320" height="770" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-120" value="virtio_device" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF00FF;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-110">
          <mxGeometry x="320" y="350" width="260" height="338" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-148" value="void *priv;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="26" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-121" value="int index;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="52" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-122" value="bool failed;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="78" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-123" value="bool config_enabled;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="104" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-124" value="bool config_change_pending;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="130" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-125" value="spinlock_t config_lock;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="156" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-126" value="struct device dev;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="182" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-144" value="struct virtio_device_id id;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="208" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-145" value="const struct virtio_config_ops *config;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="234" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-146" value="const struct vringh_config_ops *vringh_config;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="260" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-221" value="void *priv;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="286" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-147" value="u64 features;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-120">
          <mxGeometry y="312" width="260" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-111" value="struct virtio_driver" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF00FF;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-110">
          <mxGeometry x="870" y="350" width="270" height="364" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-188" value="int (*freeze)(struct virtio_device *dev);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="26" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-189" value="int (*restore)(struct virtio_device *dev);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="52" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-112" value="struct device_driver driver;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="78" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-113" value="const struct virtio_device_id *id_table;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="104" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-114" value="const unsigned int *feature_table;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="130" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-115" value="unsigned int feature_table_size;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="156" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-116" value="const unsigned int *feature_table_legacy;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="182" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-117" value="unsigned int feature_table_size_legacy;" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="208" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-118" value="int (*validate)(struct virtio_device *dev);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="234" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-119" value="int (*probe)(struct virtio_device *dev);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="260" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-173" value="void (*scan)(struct virtio_device *dev);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="286" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-174" value="void (*remove)(struct virtio_device *dev);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="312" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-175" value="void (*config_changed)(struct virtio_device *dev);" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-111">
          <mxGeometry y="338" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-149" value="&lt;font color=&quot;#0000FF&quot;&gt;/**&lt;br&gt;&amp;nbsp;* virtio_device - representation of a device using virtio&lt;br&gt;&amp;nbsp;* @index: &lt;font color=&quot;#FF0080&quot;&gt;unique position on the virtio bus&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @failed: saved value for VIRTIO_CONFIG_S_FAILED bit (for restore)&lt;br&gt;&amp;nbsp;* @config_enabled: &lt;font color=&quot;#FF0080&quot;&gt;configuration change reporting enabled&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @config_change_pending: configuration change reported while disabled&lt;br&gt;&amp;nbsp;* @config_lock: protects configuration change reporting&lt;br&gt;&amp;nbsp;* @dev: underlying device.&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;// OOP: 继承特性&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @id: &lt;font color=&quot;#FF0080&quot;&gt;the device type identification (used to match it with a driver)&lt;/font&gt;.&lt;br&gt;&amp;nbsp;* @config: the configuration ops for this device.&lt;br&gt;&amp;nbsp;* @vringh_config: &lt;font color=&quot;#FF0080&quot;&gt;configuration ops for host vrings&lt;/font&gt;.&lt;br&gt;&amp;nbsp;* @vqs: &lt;font color=&quot;#FF0080&quot;&gt;the list of virtqueues for this device&lt;/font&gt;.&lt;br&gt;&amp;nbsp;* @features: &lt;font color=&quot;#FF0080&quot;&gt;the features supported by both driver and device&lt;/font&gt;.&lt;br&gt;&amp;nbsp;* @priv: private pointer for the driver&#39;s use.&lt;br&gt;&amp;nbsp;*/&lt;br&gt;&lt;/font&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-110">
          <mxGeometry x="110" y="80" width="550" height="250" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-218" value="&lt;font color=&quot;#0000FF&quot;&gt;/**&lt;br&gt;&amp;nbsp;* virtio_driver - operations for a virtio I/O driver&lt;br&gt;&amp;nbsp;* @driver: underlying device driver (populate name and owner).&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;//OOP: 继承特性&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @id_table: &lt;font color=&quot;#FF0080&quot;&gt;the ids serviced by this driver&lt;/font&gt;.&lt;br&gt;&amp;nbsp;* @feature_table: &lt;font color=&quot;#FF0080&quot;&gt;an array of feature numbers supported by this driver&lt;/font&gt;.&lt;br&gt;&amp;nbsp;* @feature_table_size: number of entries in the feature table array.&lt;br&gt;&amp;nbsp;* @feature_table_legacy: &lt;font color=&quot;#FF0080&quot;&gt;same as feature_table but when working in legacy mode&lt;/font&gt;.&lt;br&gt;&amp;nbsp;* @feature_table_size_legacy: number of entries in feature table legacy array.&lt;br&gt;&amp;nbsp;* @probe: the function to call when a device is found.&amp;nbsp; Returns 0 or -errno.&lt;br&gt;&amp;nbsp;* @scan: &lt;font color=&quot;#FF0080&quot;&gt;optional function to call after successful probe; intended&lt;/font&gt;&lt;br&gt;&amp;nbsp;*&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;for virtio-scsi to invoke a scan.&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @remove: the function to call when a device is removed.&lt;br&gt;&amp;nbsp;* @config_changed: &lt;font color=&quot;#FF0080&quot;&gt;&lt;font color=&quot;#FF00FF&quot;&gt;optional&lt;/font&gt; function to call when the device configuration&lt;/font&gt;&lt;br&gt;&amp;nbsp;*&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;changes; may be called in interrupt context.&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @freeze: &lt;font color=&quot;#FF0080&quot;&gt;optional&lt;/font&gt; function to call during suspend/hibernation.&lt;br&gt;&amp;nbsp;* @restore: &lt;font color=&quot;#FF0080&quot;&gt;optional&lt;/font&gt; function to call on resume.&lt;br&gt;&amp;nbsp;*/&lt;br&gt;&lt;/font&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-110">
          <mxGeometry x="680" y="80" width="590" height="250" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-219" value="" style="endArrow=classic;startArrow=classic;html=1;fontSize=14;fontColor=#FF0080;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-110" source="rIxsQ2cH_EEwt95zl_0N-144" target="rIxsQ2cH_EEwt95zl_0N-114">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="580" y="510" as="sourcePoint" />
            <mxPoint x="630" y="460" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-220" value="&lt;div style=&quot;font-size: 15px&quot;&gt;&lt;font style=&quot;font-size: 15px&quot;&gt;virtio_bus.virtio_dev_match&lt;/font&gt;&lt;/div&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#FF0080;rounded=1;" vertex="1" connectable="0" parent="rIxsQ2cH_EEwt95zl_0N-219">
          <mxGeometry x="-0.3442" relative="1" as="geometry">
            <mxPoint x="44.53" y="-17.76" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-246" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=-0.004;entryY=0.291;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=14;fontColor=#FF0080;" edge="1" parent="1" source="rIxsQ2cH_EEwt95zl_0N-27" target="rIxsQ2cH_EEwt95zl_0N-47">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3460" y="5074" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-27" value="&lt;font color=&quot;#FF0080&quot;&gt;rpmsg device的id.name是来自于remote sevice的name。&lt;/font&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="3350" y="2600" width="277.5" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-254" value="drivers/remoteproc/rcar_cr7_remoteproc.c" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="9150" y="1090" width="680" height="590" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-263" value="struct platform_driver rcar_cr7_rproc_driver" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=#dae8fc;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;strokeColor=#6c8ebf;fontColor=#FF0080;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-254">
          <mxGeometry x="70" y="60" width="390" height="182" as="geometry">
            <mxRectangle x="150" y="130" width="100" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-264" value=".probe = rcar_cr7_rproc_probe," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;fontColor=#FF0080;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-263">
          <mxGeometry y="26" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-265" value=".remove = rcar_cr7_rproc_remove," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-263">
          <mxGeometry y="52" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-266" value=".driver = {" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-263">
          <mxGeometry y="78" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-267" value=".name = &quot;rcar-cr7-rproc&quot;," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=center;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;fontColor=#FF0080;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-263">
          <mxGeometry y="104" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-268" value=".of_match_table = of_match_ptr(rcar_cr7_rproc_of_match)," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=center;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-263">
          <mxGeometry y="130" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-269" value="}," style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontStyle=2;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-263">
          <mxGeometry y="156" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-262" value="static const struct of_device_id rcar_cr7_rproc_of_match[] = {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { .compatible = &quot;&lt;font color=&quot;#FF0080&quot;&gt;renesas,rcar-cr7&lt;/font&gt;&quot;, },&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { },&lt;br&gt;};" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-254">
          <mxGeometry x="50" y="260" width="460" height="60" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-270" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=14;fontColor=#FF0080;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-254" source="rIxsQ2cH_EEwt95zl_0N-268" target="rIxsQ2cH_EEwt95zl_0N-262">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="30" y="203" />
              <mxPoint x="30" y="290" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-271" value="&lt;div&gt;int rcar_cr7_rproc_probe(struct platform_device *pdev)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rproc *&lt;font color=&quot;#FF0080&quot;&gt;rproc&lt;/font&gt;;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* 分配remote processor handle，并设置它 */&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;rproc&lt;/font&gt; = &lt;font color=&quot;#FF0080&quot;&gt;rproc_alloc&lt;/font&gt;(dev, &quot;cr7&quot;, &amp;amp;rcar_cr7_rproc_ops, rcar_cr7_fw_name,&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; sizeof(*rrproc));&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* register a remote processor */&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;rproc_add&lt;/font&gt;(rproc);&lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-254">
          <mxGeometry x="50" y="340" width="570" height="140" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-284" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#FF0080;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-254" source="rIxsQ2cH_EEwt95zl_0N-264" target="rIxsQ2cH_EEwt95zl_0N-271">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="650" y="330" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-287" value="" style="endArrow=classic;html=1;fontSize=14;fontColor=#FF0080;entryX=1.002;entryY=0.907;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-254" target="rIxsQ2cH_EEwt95zl_0N-283">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="100" y="420" as="sourcePoint" />
            <mxPoint x="-20" y="560" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-288" value="" style="endArrow=classic;html=1;fontSize=14;fontColor=#FF0080;entryX=0.997;entryY=0.893;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="rIxsQ2cH_EEwt95zl_0N-254" target="rIxsQ2cH_EEwt95zl_0N-286">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="110" y="470" as="sourcePoint" />
            <mxPoint x="-30" y="510" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-261" value="drivers/virtio/virtio_ring.c" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="5780" y="2890" width="1200" height="1170" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-272" value="drivers/remoteproc/remoteproc_core.c" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="7690" y="1080" width="1220" height="2770" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-283" value="&lt;font color=&quot;#0000FF&quot;&gt;/**&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;rproc_alloc&lt;/font&gt;() - &lt;font color=&quot;#FF0080&quot;&gt;allocate a remote processor handle&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @dev: the underlying device&lt;br&gt;&amp;nbsp;* @&lt;font color=&quot;#FF0080&quot;&gt;name&lt;/font&gt;: &lt;font color=&quot;#FF0080&quot;&gt;name of this remote processor&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @&lt;font color=&quot;#FF0080&quot;&gt;ops&lt;/font&gt;: &lt;font color=&quot;#FF0080&quot;&gt;platform-specific handlers (mainly start/stop)&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @&lt;font color=&quot;#FF0080&quot;&gt;firmware&lt;/font&gt;: &lt;font color=&quot;#FF0080&quot;&gt;name of firmware file to load, can be NULL&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @len: length of private data needed by the rproc driver (in bytes)&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;Allocates&lt;/font&gt; a new remote processor handle, &lt;font color=&quot;#FF0080&quot;&gt;but does not register&lt;/font&gt;&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;it yet&lt;/font&gt;. if @firmware is NULL, a default name is used.&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;This function should be used by rproc implementations during initialization&lt;/font&gt;&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;of the remote processor&lt;/font&gt;.&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* After creating an rproc handle using this function, and when ready,&lt;br&gt;&amp;nbsp;* implementations &lt;font color=&quot;#FF0080&quot;&gt;should then call rproc_add() to complete&lt;/font&gt;&lt;br&gt;&amp;nbsp;* the registration of the remote processor.&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* On success the new rproc is returned, and on failure, NULL.&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* Note: _never_ directly deallocate @rproc, even if it was not registered&lt;br&gt;&amp;nbsp;* yet. Instead, when you need to unroll rproc_alloc(), use rproc_free().&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*/&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;struct rproc *&lt;font color=&quot;#FF0080&quot;&gt;rproc_alloc&lt;/font&gt;(struct device *dev, const char *name,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; const struct rproc_ops *ops,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; const char *firmware, int len)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct rproc *rproc;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; char *p, *template = &quot;rproc-%s-fw&quot;;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; int name_len;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;// 为rproc + private data分配内存&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#FF0080&quot;&gt;rproc = kzalloc&lt;/font&gt;(sizeof(struct rproc) + len, GFP_KERNEL); &lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;// 设置rproc&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;firmware = p;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;name &lt;/font&gt;= &lt;font color=&quot;#FF0080&quot;&gt;name&lt;/font&gt;;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;ops &lt;/font&gt;= &lt;font color=&quot;#FF0080&quot;&gt;ops&lt;/font&gt;;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;priv = &amp;amp;rproc[1];&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;&lt;font color=&quot;#FF0080&quot;&gt;auto_boot = true&lt;/font&gt;;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;// ture才会调用rproc_trigger_auto_boot&lt;/font&gt; &lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; device_initialize(&amp;amp;rproc-&amp;gt;dev);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;dev.parent = dev;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;dev.type = &amp;amp;rproc_type;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;dev.class = &amp;amp;rproc_class;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;dev.driver_data = rproc;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* Assign a unique device index and name */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;index = ida_simple_get(&amp;amp;rproc_dev_index, 0, 0, GFP_KERNEL);&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; dev_set_name(&amp;amp;rproc-&amp;gt;dev, &quot;&lt;font color=&quot;#FF0080&quot;&gt;remoteproc%d&lt;/font&gt;&quot;, rproc-&amp;gt;index); &lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* Set ELF as the default fw_ops handler */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;fw_ops = &amp;amp;&lt;font color=&quot;#FF0080&quot;&gt;rproc_elf_fw_ops&lt;/font&gt;;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; idr_init(&amp;amp;rproc-&amp;gt;notifyids);&amp;nbsp; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; rproc-&amp;gt;state = &lt;font color=&quot;#FF0080&quot;&gt;RPROC_OFFLINE&lt;/font&gt;;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return rproc;&lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-272">
          <mxGeometry x="30" y="40" width="570" height="886" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-286" value="&lt;font color=&quot;#0000FF&quot;&gt;/**&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;rproc_add&lt;/font&gt;() - &lt;font color=&quot;#FF0080&quot;&gt;register a remote processor&lt;/font&gt;&lt;br&gt;&amp;nbsp;* @rproc: the remote processor handle to register&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;Registers @rproc with the remoteproc framework&lt;/font&gt;, &lt;font color=&quot;#FF0080&quot;&gt;after&lt;/font&gt; it has been&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;allocated with rproc_alloc()&lt;/font&gt;.&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* This is called by the platform-specific rproc implementation, &lt;font color=&quot;#FF0080&quot;&gt;whenever&lt;/font&gt;&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;a new remote processor device is probed&lt;/font&gt;.&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* Returns 0 on success and an appropriate error code otherwise.&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* Note: this function &lt;font color=&quot;#FF0080&quot;&gt;initiates an asynchronous firmware loading&lt;/font&gt;&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;context, which will look for virtio devices supported by the rproc&#39;s&lt;/font&gt;&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;firmware&lt;/font&gt;.&lt;br&gt;&amp;nbsp;*&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;If found, those virtio devices will be created and added&lt;/font&gt;, so as a result&lt;br&gt;&amp;nbsp;* of registering this remote processor, &lt;font color=&quot;#FF0080&quot;&gt;additional virtio drivers might be&lt;/font&gt;&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;probed&lt;/font&gt;.&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*/&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;int &lt;font color=&quot;#FF0080&quot;&gt;rproc_add&lt;/font&gt;(struct rproc *rproc)&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* if rproc is marked always-on, request it to boot */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (rproc-&amp;gt;auto_boot) {&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ret = &lt;font color=&quot;#FF0080&quot;&gt;rproc_trigger_auto_boot&lt;/font&gt;(rproc);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; if (ret &amp;lt; 0)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return ret;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;font color=&quot;#0000FF&quot;&gt;/* expose to rproc_get_by_phandle users */&lt;/font&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; mutex_lock(&amp;amp;rproc_list_mutex);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; list_add(&amp;amp;rproc-&amp;gt;node, &amp;amp;rproc_list);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; mutex_unlock(&amp;amp;rproc_list_mutex);&lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-272">
          <mxGeometry x="630" y="60" width="550" height="490" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-289" value="include/linux/virtio_config.h" style="swimlane;fontStyle=0;fontFamily=Lucida Console;fontColor=#FF00FF;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="5720" y="150" width="1870" height="770" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-235" value="&lt;font color=&quot;#0000FF&quot;&gt;/**&lt;br&gt;&amp;nbsp;* &lt;font color=&quot;#FF0080&quot;&gt;virtio_config_ops&lt;/font&gt; - operations for configuring a virtio device&lt;br&gt;&amp;nbsp;* @get: &lt;font color=&quot;#FF0080&quot;&gt;read&lt;/font&gt; the value of a &lt;font color=&quot;#FF0080&quot;&gt;configuration field&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @set: &lt;font color=&quot;#FF0080&quot;&gt;write&lt;/font&gt; the value of a &lt;font color=&quot;#FF0080&quot;&gt;configuration field&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @generation: config generation counter&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @get_status: &lt;font color=&quot;#FF0080&quot;&gt;read the status byte&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @set_status: &lt;font color=&quot;#FF0080&quot;&gt;write the status byte&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @reset: reset the device&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @&lt;font color=&quot;#FF0080&quot;&gt;find_vqs&lt;/font&gt;: &lt;font color=&quot;#FF0080&quot;&gt;find virtqueues and instantiate them&lt;/font&gt;.&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @del_vqs: free virtqueues found by find_vqs().&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @get_features: &lt;font color=&quot;#FF0080&quot;&gt;get the array of feature bits for this device&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @finalize_features: confirm what device features we&#39;ll be using.&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @bus_name: return the bus name associated with the device&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @set_vq_affinity: &lt;font color=&quot;#FF0080&quot;&gt;set the affinity for a virtqueue&lt;/font&gt;.&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;* @get_vq_affinity: get the affinity for a virtqueue (optional).&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#0000FF&quot;&gt;&amp;nbsp;*/&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;size=14;verticalAlign=top;align=left;spacingTop=-6;fontFamily=Lucida Console;fontColor=#333333;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-289">
          <mxGeometry x="30" y="70" width="550" height="240" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-325" value="&lt;div&gt;static inline&lt;/div&gt;&lt;div&gt;int virtio_find_vqs(struct virtio_device *vdev, unsigned nvqs,&lt;br&gt;&lt;/div&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct virtqueue *vqs[], vq_callback_t *callbacks[],&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; const char * const names[],&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; struct irq_affinity *desc)&lt;br&gt;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; return vdev-&amp;gt;config-&amp;gt;find_vqs(vdev, nvqs, vqs, callbacks, names, NULL, desc);&lt;br&gt;}" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;fontFamily=Lucida Console;fontColor=#000000;shadow=0;labelBackgroundColor=#FFF4C3;rounded=1;" vertex="1" parent="rIxsQ2cH_EEwt95zl_0N-289">
          <mxGeometry x="40" y="336" width="640" height="144" as="geometry" />
        </mxCell>
        <mxCell id="rIxsQ2cH_EEwt95zl_0N-324" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=14;fontColor=#FF0080;" edge="1" parent="1" source="rIxsQ2cH_EEwt95zl_0N-145" target="rIxsQ2cH_EEwt95zl_0N-235">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4660" y="737" />
              <mxPoint x="4660" y="890" />
              <mxPoint x="5620" y="890" />
              <mxPoint x="5620" y="340" />
            </Array>
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
